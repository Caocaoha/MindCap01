import { useEffect } from 'react';
import { db } from '../db';

export const useMidnightReset = () => {
  useEffect(() => {
    const checkAndReset = async () => {
      const now = new Date();
      const todayStr = now.toISOString().split('T')[0];
      
      // Kiểm tra lần chạy cuối cùng
      const lastRun = await db.app_state.get('last_midnight_reset');
      
      if (lastRun?.value !== todayStr) {
        console.log('Mind OS: Running Midnight Cleanup...');

        await db.transaction('rw', db.entries, db.app_state, async () => {
          const allTasks = await db.entries.toArray();

          for (const task of allTasks) {
            // 1. DỌN DẸP TIÊU ĐIỂM (Focus Cleanup)
            // Nếu còn treo ở Focus -> Đá về Inbox
            if (task.status === 'active' && task.is_focus) {
              await db.entries.update(task.id, { is_focus: false });
            }

            // 2. LƯU TRỮ VIỆC CŨ (Archive Old Completed)
            // Nếu đã xong và KHÔNG PHẢI xong hôm nay -> Archive
            if (task.status === 'completed') {
              const taskDate = new Date(task.completed_at || task.created_at).toISOString().split('T')[0];
              if (taskDate !== todayStr) {
                await db.entries.update(task.id, { status: 'archived' });
              }
            }
          }

          // Cập nhật ngày chạy
          await db.app_state.put({ key: 'last_midnight_reset', value: todayStr });
        });
        
        console.log('Mind OS: Cleanup Complete.');
      }
    };

    // Chạy ngay khi mở App
    checkAndReset();

    // Chạy mỗi khi App được focus lại (phòng trường hợp để App qua đêm không tắt)
    window.addEventListener('focus', checkAndReset);
    return () => window.removeEventListener('focus', checkAndReset);
  }, []);
};