import { useEffect } from 'react';
import { db } from '../db';
import { getDateMetadata } from '../utils/date';

export const useMidnightReset = () => {
  useEffect(() => {
    const runReset = async () => {
      const todayStr = getDateMetadata().date_str;
      const lastResetState = await db.app_state.get('last_midnight_reset');
      
      // Nếu chưa có log hoặc log là ngày hôm qua -> Chạy Reset
      if (!lastResetState || lastResetState.value !== todayStr) {
        console.log("Mind OS: System Awakening - Running Midnight Reset...");
        
        await db.transaction('rw', db.entries, db.activity_logs, db.app_state, async () => {
          // 1. Reset Daily Tasks: Tìm task 'daily' đang active/completed
          const dailyTasks = await db.entries
            .filter(e => e.is_task && e.frequency === 'daily')
            .toArray();

          for (const task of dailyTasks) {
            // Reset trạng thái về Active và tắt Focus
            await db.entries.update(task.id, {
              status: 'active',
              is_focus: false, 
            });
            
            // Log lại sự kiện hệ thống
            await db.activity_logs.add({
              id: crypto.randomUUID(),
              created_at: Date.now(),
              action_type: 'SYSTEM_RESET',
              entry_id: task.id,
              value_snapshot: { prev_status: task.status } // Lưu lại để biết hôm qua có làm xong không
            });
          }

          // 2. Dọn dẹp: Archive các One-time tasks đã xong
          await db.entries
            .filter(e => e.is_task && e.status === 'completed' && (!e.frequency || e.frequency === 'custom'))
            .modify({ status: 'archived' });

          // 3. Đóng dấu thời gian
          await db.app_state.put({ key: 'last_midnight_reset', value: todayStr });
        });
        
        console.log("Mind OS: Midnight Reset Completed.");
      }
    };

    runReset();
  }, []);
};