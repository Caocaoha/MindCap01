import { useEffect } from 'react';
import { db } from '../db';

export const useMidnightReset = () => {
  useEffect(() => {
    const checkAndReset = async () => {
      const now = new Date();
      const todayStr = now.toISOString().split('T')[0];
      
      const lastRun = await db.app_state.get('last_midnight_reset');
      
      if (lastRun?.value !== todayStr) {
        console.log('Mind OS: Running Midnight Cleanup...');

        await db.transaction('rw', db.entries, db.app_state, async () => {
          const allTasks = await db.entries.toArray();

          for (const task of allTasks) {
            // 1. VIỆC ĐANG TREO Ở TÂM TRÍ (FOCUS) -> QUÊN ĐI, TRẢ VỀ KHO
            if (task.status === 'active' && task.is_focus) {
              await db.entries.update(task.id, { 
                is_focus: false,
                created_at: Date.now() // Reset thời gian để nhảy lên đầu Kho Todo
              });
            }

            // 2. VIỆC ĐÃ XONG HÔM QUA -> CẤT VÀO LỊCH SỬ (ARCHIVE)
            if (task.status === 'completed') {
              const completedDate = new Date(task.completed_at || task.created_at).toISOString().split('T')[0];
              if (completedDate !== todayStr) {
                await db.entries.update(task.id, { status: 'archived' });
              }
            }
          }

          await db.app_state.put({ key: 'last_midnight_reset', value: todayStr });
        });
        
        console.log('Mind OS: Cleanup Complete.');
      }
    };

    checkAndReset();
    window.addEventListener('focus', checkAndReset);
    return () => window.removeEventListener('focus', checkAndReset);
  }, []);
};